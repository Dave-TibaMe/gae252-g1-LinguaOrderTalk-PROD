# GCP Cloud Run Console è¨­å®šå®Œæ•´æ­¥é©Ÿ

## ğŸ¯ å‰ç½®æº–å‚™

### 1. ç¢ºèª GCP å¸³è™Ÿèˆ‡å°ˆæ¡ˆ
- ç¢ºä¿æ‚¨æœ‰ GCP å¸³è™Ÿä¸¦å·²ç™»å…¥
- ç¢ºèªæœ‰æœ‰æ•ˆçš„ä»˜è²»å¸³è™Ÿ (Cloud Run éœ€è¦å•Ÿç”¨ä»˜è²»)
- è¨˜ä¸‹æ‚¨çš„å°ˆæ¡ˆ ID

## ğŸ“‹ æ­¥é©Ÿä¸€ï¼šå•Ÿç”¨å¿…è¦çš„ API æœå‹™

### 1.1 é€²å…¥ API èˆ‡æœå‹™é é¢
1. åœ¨ GCP Console å·¦å´é¸å–®é»æ“Š **"API èˆ‡æœå‹™"** â†’ **"ç¨‹å¼åº«"**
2. æˆ–ç›´æ¥å‰å¾€ï¼šhttps://console.cloud.google.com/apis/library

### 1.2 å•Ÿç”¨ä»¥ä¸‹ API (é€ä¸€æœå°‹ä¸¦å•Ÿç”¨)
æœå°‹ä¸¦é»æ“Šæ¯å€‹ APIï¼Œç„¶å¾Œé»æ“Š **"å•Ÿç”¨"**ï¼š

- âœ… **Cloud Run API**
- âœ… **Cloud Build API** 
- âœ… **Artifact Registry API**
- âœ… **Cloud Translation API**
- âœ… **Cloud Speech-to-Text API**
- âœ… **Cloud SQL Admin API** (å¦‚æœä½¿ç”¨ Cloud SQL)
- âœ… **Maps JavaScript API** (å¦‚æœéœ€è¦)

## ğŸ“¦ æ­¥é©ŸäºŒï¼šå»ºç«‹ Artifact Registry å„²å­˜åº«

### 2.1 é€²å…¥ Artifact Registry
1. å·¦å´é¸å–®é»æ“Š **"Artifact Registry"** â†’ **"å„²å­˜åº«"**
2. æˆ–å‰å¾€ï¼šhttps://console.cloud.google.com/artifacts

### 2.2 å»ºç«‹æ–°å„²å­˜åº«
1. é»æ“Š **"å»ºç«‹å„²å­˜åº«"**
2. å¡«å…¥ä»¥ä¸‹è³‡è¨Šï¼š
   - **åç¨±**: `peter-repo`
   - **æ ¼å¼**: `Docker`
   - **ä½ç½®é¡å‹**: `åœ°å€`
   - **åœ°å€**: `asia-east1 (å°ç£)`
   - **æè¿°**: `Peter app container images`
3. é»æ“Š **"å»ºç«‹"**

## ğŸ” æ­¥é©Ÿä¸‰ï¼šå»ºç«‹æœå‹™å¸³è™Ÿ

### 3.1 é€²å…¥ IAM é é¢
1. å·¦å´é¸å–®é»æ“Š **"IAM èˆ‡ç®¡ç†"** â†’ **"æœå‹™å¸³è™Ÿ"**
2. æˆ–å‰å¾€ï¼šhttps://console.cloud.google.com/iam-admin/serviceaccounts

### 3.2 å»ºç«‹æ–°æœå‹™å¸³è™Ÿ
1. é»æ“Š **"å»ºç«‹æœå‹™å¸³è™Ÿ"**
2. å¡«å…¥è³‡è¨Šï¼š
   - **æœå‹™å¸³è™Ÿåç¨±**: `peter-deployment-sa`
   - **æœå‹™å¸³è™Ÿ ID**: `peter-deployment-sa` (è‡ªå‹•ç”¢ç”Ÿ)
   - **æè¿°**: `Service account for Peter app deployment`
3. é»æ“Š **"å»ºç«‹ä¸¦ç¹¼çºŒ"**

### 3.3 æˆäºˆè§’è‰²æ¬Šé™
åœ¨ "å°‡æ­¤æœå‹™å¸³è™Ÿçš„å­˜å–æ¬Šæˆäºˆå°ˆæ¡ˆ" å€æ®µï¼Œæ–°å¢ä»¥ä¸‹è§’è‰²ï¼š
- `Cloud Run ç®¡ç†å“¡` (Cloud Run Admin)
- `Artifact Registry å¯«å…¥è€…` (Artifact Registry Writer)
- `å„²å­˜ç©ºé–“ç®¡ç†å“¡` (Storage Admin)

é»æ“Š **"ç¹¼çºŒ"** â†’ **"å®Œæˆ"**

### 3.4 å»ºç«‹æœå‹™å¸³è™Ÿé‡‘é‘°
1. åœ¨æœå‹™å¸³è™Ÿåˆ—è¡¨ä¸­ï¼Œé»æ“Šå‰›å»ºç«‹çš„ `peter-deployment-sa`
2. åˆ‡æ›åˆ° **"é‡‘é‘°"** åˆ†é 
3. é»æ“Š **"æ–°å¢é‡‘é‘°"** â†’ **"å»ºç«‹æ–°é‡‘é‘°"**
4. é¸æ“‡ **"JSON"** æ ¼å¼
5. é»æ“Š **"å»ºç«‹"** ä¸¦ä¸‹è¼‰ JSON æª”æ¡ˆ
6. **å¦¥å–„ä¿å­˜æ­¤æª”æ¡ˆï¼Œç¨å¾Œéœ€è¦ç”¨æ–¼ GitHub Secrets**

## ğŸ—„ï¸ æ­¥é©Ÿå››ï¼šè¨­å®šè³‡æ–™åº« (é¸æ“‡å…¶ä¸€)

### é¸é … Aï¼šä½¿ç”¨ Cloud SQL (æ¨è–¦)

#### 4.1 å»ºç«‹ Cloud SQL å¯¦ä¾‹
1. å·¦å´é¸å–®é»æ“Š **"SQL"**
2. é»æ“Š **"å»ºç«‹å¯¦ä¾‹"**
3. é¸æ“‡ **"MySQL"**
4. è¨­å®šï¼š
   - **å¯¦ä¾‹ ID**: `peter-mysql-instance`
   - **å¯†ç¢¼**: è¨­å®š root å¯†ç¢¼
   - **åœ°å€**: `asia-east1`
   - **å€åŸŸ**: `asia-east1-a`
   - **æ©Ÿå™¨é¡å‹**: `db-f1-micro` (é–‹ç™¼ç”¨) æˆ– `db-n1-standard-1` (ç”Ÿç”¢ç”¨)
5. é»æ“Š **"å»ºç«‹"**

#### 4.2 å»ºç«‹è³‡æ–™åº«å’Œä½¿ç”¨è€…
1. å¯¦ä¾‹å»ºç«‹å®Œæˆå¾Œï¼Œé»æ“Šå¯¦ä¾‹åç¨±é€²å…¥è©³ç´°é é¢
2. åœ¨ **"è³‡æ–™åº«"** åˆ†é ï¼Œé»æ“Š **"å»ºç«‹è³‡æ–™åº«"**ï¼š
   - **è³‡æ–™åº«åç¨±**: `linguaordertalk`
3. åœ¨ **"ä½¿ç”¨è€…"** åˆ†é ï¼Œé»æ“Š **"æ–°å¢ä½¿ç”¨è€…å¸³æˆ¶"**ï¼š
   - **ä½¿ç”¨è€…åç¨±**: `peter`
   - **å¯†ç¢¼**: è¨­å®šå¯†ç¢¼
   - **ä¸»æ©Ÿ**: `%` (å…è¨±ä»»ä½•ä¸»æ©Ÿé€£ç·š)

#### 4.3 å–å¾—é€£ç·šè³‡è¨Š
1. åœ¨å¯¦ä¾‹æ¦‚è§€é é¢ï¼Œè¤‡è£½ **"å…¬ç”¨ IP ä½å€"**
2. æ‚¨çš„ DATABASE_URL æ ¼å¼ï¼š
   ```
   mysql+aiomysql://peter:YOUR_PASSWORD@PUBLIC_IP:3306/linguaordertalk
   ```

### é¸é … Bï¼šä½¿ç”¨å¤–éƒ¨è³‡æ–™åº«
å¦‚æœæ‚¨æœ‰ç¾æœ‰çš„ MySQL è³‡æ–™åº«ï¼Œç›´æ¥ä½¿ç”¨è©²é€£ç·šè³‡è¨Šå³å¯ã€‚

## ğŸš€ æ­¥é©Ÿäº”ï¼šæ‰‹å‹•éƒ¨ç½²åˆ° Cloud Run

### 5.1 ä¸Šå‚³å®¹å™¨æ˜ åƒ

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Cloud Shell (æ¨è–¦)
1. åœ¨ GCP Console å³ä¸Šè§’é»æ“Š **"å•Ÿç”¨ Cloud Shell"** åœ–ç¤º
2. åœ¨ Cloud Shell ä¸­åŸ·è¡Œï¼š

```bash
# è¨­å®šå°ˆæ¡ˆ ID
export PROJECT_ID="your-project-id"
gcloud config set project $PROJECT_ID

# è¤‡è£½æ‚¨çš„å°ˆæ¡ˆä»£ç¢¼åˆ° Cloud Shell (å¯ä½¿ç”¨ git clone æˆ–ä¸Šå‚³)
git clone https://github.com/your-username/your-repo.git
cd your-repo/deployment/Peter

# å»ºç½®ä¸¦æ¨é€æ˜ åƒ
docker build -t asia-east1-docker.pkg.dev/$PROJECT_ID/peter-repo/peter-linguaordertalk:v1 .
docker push asia-east1-docker.pkg.dev/$PROJECT_ID/peter-repo/peter-linguaordertalk:v1
```

#### æ–¹æ³•äºŒï¼šæœ¬åœ°ä¸Šå‚³
```bash
# åœ¨æœ¬åœ°é›»è…¦ï¼Œå…ˆèªè­‰
gcloud auth login
gcloud config set project YOUR_PROJECT_ID
gcloud auth configure-docker asia-east1-docker.pkg.dev

# å»ºç½®ä¸¦æ¨é€
cd deployment/Peter
docker build -t asia-east1-docker.pkg.dev/YOUR_PROJECT_ID/peter-repo/peter-linguaordertalk:v1 .
docker push asia-east1-docker.pkg.dev/YOUR_PROJECT_ID/peter-repo/peter-linguaordertalk:v1
```

### 5.2 å»ºç«‹ Cloud Run æœå‹™

1. å·¦å´é¸å–®é»æ“Š **"Cloud Run"**
2. é»æ“Š **"å»ºç«‹æœå‹™"**
3. å¡«å…¥è¨­å®šï¼š

#### åŸºæœ¬è¨­å®š
- **å®¹å™¨æ˜ åƒæª” URL**: é»æ“Š **"é¸å–"**ï¼Œåœ¨ Artifact Registry ä¸­é¸æ“‡å‰›ä¸Šå‚³çš„æ˜ åƒ
- **æœå‹™åç¨±**: `peter-linguaordertalk`
- **åœ°å€**: `asia-east1 (å°ç£)`

#### æµé‡é…ç½®
- âœ… **å…è¨±æœªç¶“é©—è­‰çš„å«ç”¨** (å› ç‚ºéœ€è¦æ¥æ”¶ LINE webhook)

#### é€²éšè¨­å®š (é»æ“Š "å®¹å™¨ã€è®Šæ•¸ã€é€£ç·šã€å®‰å…¨æ€§")

##### å®¹å™¨åˆ†é ï¼š
- **å®¹å™¨é€šè¨ŠåŸ **: `8080`
- **è¨˜æ†¶é«”**: `1 GiB`
- **CPU**: `1`

##### è®Šæ•¸èˆ‡å¯†ç¢¼åˆ†é ï¼š
é»æ“Š **"æ–°å¢è®Šæ•¸"** é€ä¸€æ–°å¢ï¼š

| è®Šæ•¸åç¨± | å€¼ |
|---------|-----|
| `CHANNEL_ACCESS_TOKEN` | æ‚¨çš„ LINE Channel Access Token |
| `CHANNEL_SECRET` | æ‚¨çš„ LINE Channel Secret |
| `LIFF_ID` | æ‚¨çš„ LIFF ID |
| `Maps_API_KEY` | æ‚¨çš„ Google Maps API Key |
| `DATABASE_URL` | æ‚¨çš„è³‡æ–™åº«é€£ç·šå­—ä¸² |

##### é€£ç·šåˆ†é ï¼š
- **æœ€å¤§å¯¦ä¾‹æ•¸é‡**: `10`
- **æœ€å°å¯¦ä¾‹æ•¸é‡**: `0`
- **ä¸¦è¡Œè¦æ±‚æ•¸ä¸Šé™**: `100`
- **è¦æ±‚é€¾æ™‚**: `300` ç§’

4. é»æ“Š **"å»ºç«‹"**

## ğŸ”— æ­¥é©Ÿå…­ï¼šè¨­å®š LINE Bot Webhook

### 6.1 å–å¾— Cloud Run URL
1. éƒ¨ç½²å®Œæˆå¾Œï¼Œåœ¨ Cloud Run æœå‹™é é¢è¤‡è£½æœå‹™ URL
2. URL æ ¼å¼é¡ä¼¼ï¼š`https://peter-linguaordertalk-[hash]-de.a.run.app`

### 6.2 è¨­å®š LINE Webhook URL
1. å‰å¾€ [LINE Developers Console](https://developers.line.biz/)
2. é¸æ“‡æ‚¨çš„ Bot Channel
3. åœ¨ **"Messaging API"** åˆ†é ä¸­ï¼š
   - **Webhook URL**: `https://your-cloud-run-url/callback`
   - å•Ÿç”¨ **"Use webhook"**
4. é»æ“Š **"Verify"** æ¸¬è©¦é€£ç·š

## ğŸ§ª æ­¥é©Ÿä¸ƒï¼šæ¸¬è©¦éƒ¨ç½²

### 7.1 å¥åº·æª¢æŸ¥
åœ¨ç€è¦½å™¨é–‹å•Ÿï¼š`https://your-cloud-run-url/health`
æ‡‰è©²æœƒçœ‹åˆ°é¡ä¼¼ä»¥ä¸‹å›æ‡‰ï¼š
```json
{
  "status": "healthy",
  "timestamp": "2025-01-XX...",
  "service": "LinguaOrderTalk Bot",
  "database": "connected"
}
```

### 7.2 æ¸¬è©¦ LINE Bot åŠŸèƒ½
1. ç”¨æ‰‹æ©Ÿæƒæ LINE Bot QR Code åŠ å…¥å¥½å‹
2. æ¸¬è©¦åŸºæœ¬åŠŸèƒ½ï¼š
   - å‚³é€è¨Šæ¯ "Change Language"
   - å‚³é€è¨Šæ¯ "Order Now"
   - æ¸¬è©¦èªéŸ³è¾¨è­˜å’Œä½ç½®åˆ†äº«

## ğŸ“Š æ­¥é©Ÿå…«ï¼šç›£æ§èˆ‡æ—¥èªŒ

### 8.1 æŸ¥çœ‹æœå‹™æ—¥èªŒ
1. åœ¨ Cloud Run æœå‹™é é¢ï¼Œé»æ“Š **"æ—¥èªŒ"** åˆ†é 
2. æˆ–å‰å¾€ **"Logging"** â†’ **"æ—¥èªŒç€è¦½å™¨"**

### 8.2 è¨­å®šç›£æ§è­¦å ± (å¯é¸)
1. å‰å¾€ **"Monitoring"** â†’ **"Alerting"**
2. å»ºç«‹è­¦å ±åŸå‰‡ç›£æ§ï¼š
   - æœå‹™å›æ‡‰æ™‚é–“
   - éŒ¯èª¤ç‡
   - è¨˜æ†¶é«”ä½¿ç”¨é‡

## ğŸ”„ å¾ŒçºŒæ›´æ–°èˆ‡ç¶­è­·

### æ–¹æ³•ä¸€ï¼šè‡ªå‹•åŒ– (æ¨è–¦)
è¨­å®š GitHub Actions å¾Œï¼Œåªéœ€æ¨é€ä»£ç¢¼å³å¯è‡ªå‹•éƒ¨ç½²

### æ–¹æ³•äºŒï¼šæ‰‹å‹•æ›´æ–°
1. å»ºç½®æ–°çš„å®¹å™¨æ˜ åƒ (ä½¿ç”¨æ–°çš„æ¨™ç±¤ï¼Œå¦‚ v2, v3...)
2. åœ¨ Cloud Run æœå‹™é é¢é»æ“Š **"ç·¨è¼¯ä¸¦éƒ¨ç½²æ–°ä¿®è¨‚ç‰ˆæœ¬"**
3. é¸æ“‡æ–°çš„å®¹å™¨æ˜ åƒ
4. é»æ“Š **"éƒ¨ç½²"**

## ğŸ›¡ï¸ å®‰å…¨æ€§æœ€ä½³å¯¦å‹™

### ç’°å¢ƒè®Šæ•¸å®‰å…¨
- æ•æ„Ÿè³‡æ–™ä½¿ç”¨ **Secret Manager** è€Œéç’°å¢ƒè®Šæ•¸ (é€²éšè¨­å®š)
- å®šæœŸè¼ªæ› API é‡‘é‘°

### ç¶²è·¯å®‰å…¨
- è€ƒæ…®ä½¿ç”¨ **VPC é€£æ¥å™¨** é€£æ¥ç§æœ‰ç¶²è·¯
- è¨­å®šé©ç•¶çš„ **IAM æ¬Šé™**

### è³‡æ–™åº«å®‰å…¨
- å•Ÿç”¨ **SSL é€£ç·š**
- ä½¿ç”¨ **æˆæ¬Šç¶²è·¯** é™åˆ¶å­˜å–ä¾†æº
- å®šæœŸå‚™ä»½è³‡æ–™

## ğŸ“ æ•…éšœæ’é™¤

### å¸¸è¦‹éŒ¯èª¤åŠè§£æ±ºæ–¹æ¡ˆ

#### éƒ¨ç½²å¤±æ•—
**éŒ¯èª¤**: "Image not found"
**è§£æ±º**: ç¢ºèªæ˜ åƒå·²æˆåŠŸæ¨é€åˆ° Artifact Registry

**éŒ¯èª¤**: "Port 8080 not accessible"
**è§£æ±º**: æª¢æŸ¥ Dockerfile ä¸­çš„ EXPOSE 8080 å’Œæ‡‰ç”¨ç¨‹å¼ç›£è½åŸ 

#### æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤
**éŒ¯èª¤**: "Database connection failed"
**è§£æ±º**: æª¢æŸ¥ DATABASE_URL ç’°å¢ƒè®Šæ•¸å’Œç¶²è·¯é€£ç·š

**éŒ¯èª¤**: "LINE webhook verification failed"
**è§£æ±º**: æª¢æŸ¥ CHANNEL_SECRET ç’°å¢ƒè®Šæ•¸

### åµéŒ¯å·¥å…·
```bash
# åœ¨ Cloud Shell ä¸­æŸ¥çœ‹å³æ™‚æ—¥èªŒ
gcloud run services logs tail peter-linguaordertalk --region=asia-east1

# æŸ¥çœ‹æœå‹™è©³ç´°è³‡è¨Š
gcloud run services describe peter-linguaordertalk --region=asia-east1
```

## ğŸ’° æˆæœ¬å„ªåŒ–å»ºè­°

### è³‡æºé…ç½®å»ºè­°
- **é–‹ç™¼ç’°å¢ƒ**: 512Mi è¨˜æ†¶é«”, 0.5 CPU
- **ç”Ÿç”¢ç’°å¢ƒ**: 1Gi è¨˜æ†¶é«”, 1 CPU
- **æœ€å°å¯¦ä¾‹æ•¸**: 0 (æŒ‰éœ€æ±‚æ“´å±•)
- **æœ€å¤§å¯¦ä¾‹æ•¸**: 5-10 (æ ¹æ“šæµé‡èª¿æ•´)

### ç›£æ§æˆæœ¬
1. å‰å¾€ **"å¸³å–®"** â†’ **"é ç®—èˆ‡å¿«è¨Š"**
2. å»ºç«‹é ç®—è­¦å ±é¿å…è¶…æ”¯

é€™å€‹è¨­å®šå®Œæˆå¾Œï¼Œæ‚¨çš„ Peter App å°±èƒ½åœ¨ Cloud Run ä¸Šç©©å®šé‹è¡Œï¼Œä¸¦è‡ªå‹•è™•ç† LINE Bot çš„æ‰€æœ‰è«‹æ±‚ï¼